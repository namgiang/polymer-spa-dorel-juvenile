<link rel="import" href="../../atoms/dorel-cta.html">
<link rel="import" href="../../atoms/dorel-bynder-image.html">
<script src="../../../node_modules/snapsvg/dist/snap.svg.js"></script>

<dom-module id="dorel-car-fitting-results">
  <template>
    <style>
      h1, h2, h3, h4 {
        @apply(--theme-header-text-transform);
      }

      [hidden] {
        display: none;
      }
      
      #positron {
        position: relative;  
      }
      
      .inner-col-left-top {
        min-height: 27rem;
      }
      .notification-box {
        background-color: var(--theme-color-monochrome-1);
        border-radius: var(--theme-button-border-radius);
        padding: 1.8rem;
        margin-bottom: 1.5rem;
      }
      /*.image-wrapper {*/
      /*  position: absolute;*/
      /*  top: 0;*/
      /*  right: 0;*/
      /*  bottom: 0;*/
      /*  width: 50%;*/
      /*  display: flex;*/
      /*  flex: 1;*/
      /*  z-index: -1000;*/
      /*}*/
      .car-selection, .car-display {
        width: auto;
        height: auto;
        /*background-color: var(--theme-color-monochrome-2);*/
        border-radius: var(--theme-button-border-radius);
        cursor: pointer;
      }
      .legend-container {
        display: flex;
        margin-top: 1rem;
      }
      .legend-container object {
        margin-right: 1rem;
      }
      .edit-card {
        padding: 1rem 0.75rem 1rem 0.75rem;
        width: 210px;
      }
      .edit-card h3 {
        margin: 0;
      }
      .edit-icon, .delete-icon {
        padding: 2.1em 1.2rem 2.1rem 1.2rem;
        --iron-icon-height: 30px;
        --iron-icon-width: 30px;
      }
      .edit-icon {
        border-right: 4px solid white;
      }
      .notification-icon {
        --iron-icon-height: 38px;
        --iron-icon-width: 38px;
        color: var(--theme-brand-color-1);
      }
      .step-title {
        font-size: var(--theme-typography-5_-_font-size);
        line-height: var(--theme-typography-5_-_line-height);
        margin-top: var(--theme-typography-5_-_margin-top);
        margin-bottom: var(--theme-typography-5_-_margin-bottom);
        font-weight: var(--theme-typography-5_-_font-weight);
        font-family: var(--theme-typography-5_-_font-family);
      }
      .product-title {
        font-size: var(--theme-typography-5_-_font-size);
        line-height: var(--theme-typography-5_-_line-height);
        margin-top: var(--theme-typography-5_-_margin-top);
        margin-bottom: var(--theme-typography-5_-_margin-bottom);
        font-weight: var(--theme-typography-5_-_font-weight);
        font-family: var(--theme-typography-5_-_font-family);
      }
      .box {
        background-color: #fff;
        border-radius: var(--theme-button-border-radius);
        padding: 2em 1.5em;
      }
      .content-title {
        @apply(--theme-typography-4);
        margin: 0;
      }
      .svg_container {
        width: 100%;
        height: 240px;
      }
      .svg_node {
        width: 100%;
        height: 100%;
      }
      .cta-wrapper {
        display: flex;
        width: 100%;
        justify-content: flex-end;
      }
      /*.background-complementary {*/
      /*  background-color: var(--theme-color-monochrome-2);*/
      /*  position: absolute;*/
      /*  top: 0;*/
      /*  bottom: 0;*/
      /*  right: 0;*/
      /*  width: 50%;*/
      /*  z-index: -1000;*/
      /*}*/
      .post {
        height: 220px;
        width: 370px;
        margin: 20px auto;
        display: flex;
        align-content: center;
        justify-content: flex-start;
      }
      .selected-product {
        text-align: left;
      }
      .imgwrapicon {
        text-align: left;
        width: 50px;
      }
      .photo {
        width: 125px;
        height: 125px;
        margin: 10px 10px 10px 20px;
      }
      .icon {
        width: 24px;
        height: 24px;
        margin: 10px 10px 0px 20px;
      }
      .info {
        /*margin: 25px 10px 10px 20px;*/
        height: 6rem;
      }
      .info .title {
         @apply(--theme-typography-4);
        float: left;
        width: 100%;
        margin: 0 0 1rem 0;
        padding: 0;
        color: var(--theme-brand-color-1);       
      }
      .timeAgo {
        font-size: 11px;
      }
      
      .content p {
        margin: 0;
        padding: 0;
      }
      
      .notification {
        position: absolute;
        width: 270px;
        height: auto;
        border-radius: 10px;
        /*padding: 25px;*/
        top: 0;
        left: 0;
        z-index: 10000;
        display: none;
        @apply(--theme-typography-1);
      }
      .notification ul {
        margin-left: -1.4rem;        
      }
      .notification-title {
        @apply(--theme-typography-3);
        padding-left: 0.5rem;
        font-weight: bold;
      }
      .tether {
        position: absolute;
        width: 150px;
        height: auto;
        /*border: 1px solid red;*/
        border-radius: 10px;
        /*padding: 25px;*/
        top: 0;
        left: 0;
        z-index: 10000;
        display: none;
        @apply(--theme-typography-1);
      }
      .fit-title {
        margin-left: 0.5rem;
      }
      .image-message {
        margin-left: 2rem;
      }
      .effect7
      {
        background:#FFF;
        padding: 25px;
        position:relative;
        -webkit-box-shadow:0 1px 4px rgba(0, 0, 0, 0.3), 0 0 40px rgba(0, 0, 0, 0.1) inset;
           -moz-box-shadow:0 1px 4px rgba(0, 0, 0, 0.3), 0 0 40px rgba(0, 0, 0, 0.1) inset;
                box-shadow:0 1px 4px rgba(0, 0, 0, 0.3), 0 0 40px rgba(0, 0, 0, 0.1) inset;
      }
      .effect7:before, .effect7:after
      {
        content:"";
        position:absolute;
        z-index:-1;
        -webkit-box-shadow:0 0 20px rgba(0,0,0,0.8);
        -moz-box-shadow:0 0 20px rgba(0,0,0,0.8);
        box-shadow:0 0 20px rgba(0,0,0,0.8);
        top:0;
        bottom:0;
        left:10px;
        right:10px;
        -moz-border-radius:100px / 10px;
        border-radius:100px / 10pxpx;
      }
      .effect7:after
      {
        right:10px;
        left:auto;
        -webkit-transform:skew(8deg) rotate(3deg);
           -moz-transform:skew(8deg) rotate(3deg);
            -ms-transform:skew(8deg) rotate(3deg);
             -o-transform:skew(8deg) rotate(3deg);
                transform:skew(8deg) rotate(3deg);
      }
      
      dorel-layout-row, dorel-layout-column {
        margin-top: 0;
      }
      
      .image-wrapper {
        border-radius: var(--theme-border-radius-2);
        width: 100%;
        height: 15em;
        /*background-color: var(--theme-color-monochrome-2);*/
        overflow: hidden;
        display: flex;
        padding: .25em;
        box-sizing: border-box;
      }
      
      .image-selected {
        width: 100%;
        height: 100%;
        max-width: 17em;
        max-height: 19.2em;
        margin: auto;
        float: none;
        display: block;
      }
    </style>
    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>
    <dorel-layout-container>
      <dorel-layout-row align="middle">
         <dorel-layout-column desktop-column-span="12" tablet-column-span="12" mobile-column-span="12" align="left">
          <template is="dom-if" if="[[ !standalone ]]" restamp="true">
            <dorel-cta title="[[ stepData.options.previous ]]" rotate no-margin type="link" link="" size="medium" icon="dorel-icons:chevron-right" on-click="previousStep">
              [[ localize('common#back') ]]
            </dorel-cta>
          </template>
        </dorel-layout-column>
      </dorel-layout-row>
      <br><br>
      <dorel-layout-row align="middle">
        <dorel-layout-column desktop-column-span="5" tablet-column-span="5" mobile-column-span="12" align="left">
            <dorel-layout-row>
                <dorel-layout-column desktop-column-span="9" tablet-column-span="9" mobile-column-span="12" class="inner-col-left-top">
                  <h1 class="step-title">[[ localize('car_fitting_results#main_section_title') ]]</h1>
                  <template id="carResults" is="dom-repeat" items="[[ carData ]]" as="car" index-as="carIndex" restamp="true">
                    <br>
                    <strong hidden$="[[ !getLabelOrNotListed(car.result) ]]">[[ localize('car_fitting_results#car_information_label_title') ]] [[ car.result.car_information_label ]]</strong>
                    <strong hidden$="[[ getLabelOrNotListed(car.result) ]]">[[ localize('car_fitting_results#car_information_label_title') ]] [[ localize('car_fitting_results#not_listed') ]]</strong>
                    <br>
                    <br>
                    <!--<object id="fit" data="/assets/images/car-fitting/icon_green.svg" type="image/svg+xml"></object>
                    <strong class="fit-title">Fit</strong>-->
                    <br> 
                    <small class="image-message">[[stepData.main_section.info]]</small>
                     [[ loadImage(car.result, carIndex) ]]
                    <div id="svg_container_[[carIndex]]" class="svg_container"></div>
                  </template>
                </dorel-layout-column>
            </dorel-layout-row>
        </dorel-layout-column>
        <dorel-layout-column desktop-column-span="5" tablet-column-span="5" mobile-column-span="12" align="left" class="col-right-top">
          <dorel-layout-row>
            <dorel-layout-column desktop-column-span="9" tablet-column-span="9" mobile-column-span="12" class="inner-col-left-top">
              <div class="notification-box">
                    <div class="selected-product">
                      <h2 class="content-title">[[ stepData.selected_product.title ]]</h2>
                      <div class="image-wrapper">
                        <dorel-product-image
                          class="image-selected"
                          sizing="contain"
                          image-url="[[currentProductImage]]"></dorel-product-image>
                        <template is="dom-if" if="[[currentBaseImage]]">
                          <dorel-product-image
                            class="image-selected"
                            sizing="contain"
                            image-url="[[currentBaseImage]]"></dorel-product-image>
                        </template>
                      </div>
                      <!--<div class="timeAgo">Explore other suitable solutions</div>-->
                    </div>
                    <div class="info">
                      <h2 class="title">[[ selectedProductName ]]</h2>
                      <dorel-cta
                        type="primary"
                        title="[[localize('dorel_section_product_showcase#does_it_fit_my_car')]]"
                        link="[[ productURL ]]"
                        size="medium"
                        icon="dorel-icons:chevron-right">[[localize('See_details')]]</dorel-cta>
                    </div>
              </div>
              <div class="notification-box">
                <h2 class="content-title">[[ localize('car_fitting_results#legend_title') ]]</h2>
                <template is="dom-repeat" items="[[ iconsUsed2 ]]" as="icon">
                <div class="legend-display">
                  <div class="legend-container">
                    <object id="fit" data="/assets/images/car-fitting/[[ icon.name ]].svg" type="image/svg+xml"></object>
                    [[ localize(icon.label) ]]
                  </div>
                </div>
                </template>
              </div>
            </dorel-layout-column>
          </dorel-layout-row>
        </dorel-layout-column> 
      </dorel-layout-row>
      <template is="dom-if" if="[[ breakpoints.tabletMediumUp ]]" restamp="true">
        <template is="dom-if" if="[[ hasBynderImage(stepData.sub_section.background_image_id) ]]">
          <dorel-bynder-image class="image"
                      derivative-identifier="Fullscreen Retina portrait"
                      sizing="cover"
                      width="100%"
                      height="100%"
                      flex
                      fade="true"
                      media-id$="[[ stepData.sub_section.background_image_id ]]"></dorel-bynder-image>
        </template>
      </template>
    </dorel-layout-container>
    <template is="dom-repeat" items="[[ carData ]]" as="car" index-as="carIndex" restamp="true">
      <template is="dom-repeat" items="[[ car.result.carseat_positions ]]" as="seat" restamp="true">
        <div id="car_[[ carIndex ]]_seat_[[ seat.seat_position ]]_notification" class="notification">
          <div class="effect7">
            <object data="/assets/images/car-fitting/icon_[[ seat.icon ]].svg" type="image/svg+xml"></object>
            <template is="dom-if" if="[[isSafetywarning(seat.icon)]]">
              <strong class="notification-title">[[localize('car_fitting_results#safety_warning')]]</strong>
            </template>
            <ul>
              <template is="dom-repeat" items="[[ seat.notices ]]" as="notification" restamp="true">

                <li>[[ localize(notification) ]]</li>
              </template>
            </ul>
          </div>
        </div>
        <div id="car_[[ carIndex ]]_seat_[[ seat.seat_position ]]_tether" class="tether">
          <div class="effect7">
            <img src="/assets/images/car-fitting/[[ seat.top_tether_position ]].jpeg">
          </div>
        </div>
      </template>
    </template>
  </template>
  <script>
    /* global Polymer */
    /* global Snap */
    /* global CustomEvent */
    /* global customElements */
    class DorelCarFittingResults extends ReduxMixin(Polymer.mixinBehaviors([DorelMultilingualBehavior], Polymer.Element)) {

      static get is() {
        return 'dorel-car-fitting-results';
      }
      
      static get properties() {
        return {
          // productImage: {
          //   type: String,
          //   computed: 'getProductImage(selectedProduct)'
          // },
          productList: {
            type: Array,
            statePath: function (state) {
             return this.productListFromState(state);
            },
          },
          iconsUsed2: Array,
          carGraphics: String,
          iconsUsed: {
            type: Object,
            value: {
              'icon_green': {
                name: 'icon_green',
                used: false,
                label: 'car_fitting_results#icon_green_label'
              },
              'icon_orange': {
                name: 'icon_orange',
                used: false,
                label: 'car_fitting_results#icon_orange_label'
              },
              'icon_red': {
                name: 'icon_red',
                used: false,
                label: 'car_fitting_results#icon_red_label'
              },
              'icon_blue': {
                name: 'icon_blue',
                used: false,
                label: 'car_fitting_results#icon_blue_label'
              },
              'icon_blue_2': {
                name: 'icon_blue_2',
                used: false,
                label: 'car_fitting_results#icon_blue_notification_label'
              },
              'icon_top_tether': {
                name: 'icon_top_tether',
                used: false,
                label: 'car_fitting_results#icon_top_tether_label'
              },
            }
          }
        };
      }
      
      static get observers() {
        return [
          'productChanged(productData.*)',
          'productDataChanged(selectedProduct.*)'
        ];
      }

      productListFromState(state) {
          const data = {
            carseat: state.product.products[0]
          };
          if(data.carseat.isLoading === false && data.carseat.notAvailable === false) {
            this.set('selectedProduct', data);
          }
      }

      productDataChanged(data) {
        if(data.value.carseat) {
          this.selectedProductName = (data.value.base ? `${data.value.carseat.name.value} & ${data.value.base.name.value}` : data.value.carseat.name.value);
          this.currentProductImage = data.value.carseat.child_products[0].images.image;
          this.currentBaseImage = (data.value.base) ? data.value.base.child_products[0].images.image : null;
          //this.productURL = `${window.location.origin}/${window.location.pathname.split('/')[1]}/${window.location.pathname.split('/')[2]}/${data.value.carseat.linkUrl}`;
          /* @todo read out product template en link there */ 
          this.productURL = `/gb-en/car-seats/${data.value.carseat.url}`;
        }
      }

      isSafetywarning(icon) {
        return (icon === 'orange') ? true : false;
      }
      
      productChanged() {
        //debugger;  
      }

      getFitOrNoFit (data) {
        //debugger;
      }

      getIconLabel(icon) {
        var test = this.iconsUsed[icon].label;
        //debugger;
        return this.iconsUsed[icon].label;
      }

      getLabelOrNotListed (data) {
        if(data) return (data.carseat_positions);
      }

      renderLegend() {
        let iconsUsed = [];
        Object.keys(this.iconsUsed).filter(function(icon) {
          return this.iconsUsed[icon].used;
        }.bind(this)).filter(function(icon) {
          iconsUsed.push(this.iconsUsed[icon]);
        }.bind(this));
        return iconsUsed;
      }
      
      offset(el) {
        const rect = el.getBoundingClientRect(),
        scrollLeft = window.pageXOffset || document.documentElement.scrollLeft,
        scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        return { top: rect.top + scrollTop, left: rect.left + scrollLeft }
      }

      loadImage(data, carIndex) {
        if(data) {
          if(data.carseat_positions) {

            this.iconsUsed.icon_green.used = false;
            this.iconsUsed.icon_orange.used = false;
            this.iconsUsed.icon_red.used = false;
            this.iconsUsed.icon_blue_2.used = false;
            this.iconsUsed.icon_green.used = false; 
            this.iconsUsed.icon_top_tether.used = false;

            let self = this;
            let svgCarNode = null;
            function onSVGLoaded(loadedFragment) {
              svgCarNode.append(loadedFragment);
              svgCarNode.attr({
                opacity: 0
              });
              svgCarNode.select('#small_car').attr({'visibility': 'hidden'});
              svgCarNode.select('#normal_car').attr({'visibility': 'hidden'});
              svgCarNode.select('#big_car').attr({'visibility': 'hidden'});
              const seats = ['0', '1', '2', '3', '4', '5', '6', '7'];
              for(var seat in seats) {
                const seatNode = svgCarNode.select(`#seat_${seats[seat]}`);
                if(seatNode) {
                  svgCarNode.select(`#seat_${seats[seat]}`).attr({'visibility': 'hidden'});
                  svgCarNode.select(`#seat_${seats[seat]} #icon_green`).attr({'visibility': 'hidden'});
                  svgCarNode.select(`#seat_${seats[seat]} #icon_red`).attr({'visibility': 'hidden'});
                  svgCarNode.select(`#seat_${seats[seat]} #icon_orange`).attr({'visibility': 'hidden'});
                  svgCarNode.select(`#seat_${seats[seat]} #icon_blue`).attr({'visibility': 'hidden'});
                  svgCarNode.select(`#seat_${seats[seat]} #icon_blue_2`).attr({'visibility': 'hidden'});
                  svgCarNode.select(`#seat_${seats[seat]} #icon_tether`).attr({'visibility': 'hidden'});
                }
              }
              if(data.car_body_configuration.includes('bench')) {
                const car_body = data.car_body_configuration.substring(0, data.car_body_configuration.length - 6);
                svgCarNode.select(`#${car_body}`).attr({'visibility': 'visible'});
              } else {
                svgCarNode.select(`#${data.car_body_configuration}`).attr({'visibility': 'visible'});
              }

              data.carseat_positions.forEach(function(item) {
                if(item.icon === 'green') {
                  self.iconsUsed.icon_green.used = true;
                  svgCarNode.select(`#seat_${item.seat_position}`).attr({'visibility': 'visible'});
                  svgCarNode.select(`#seat_${item.seat_position} #icon_green`).attr({'visibility': 'visible'});
                  const greenIcon = svgCarNode.select(`#seat_${item.seat_position} #icon_green #hover_area`);
                  const notice = self.shadowRoot.querySelector(`#car_${carIndex}_seat_${item.seat_position}_notification`);
                  greenIcon.mousemove(function(event) {
                    const offset = self.offset(event.currentTarget);
                    notice.style.left = `${offset.left + 40}px`;
                    notice.style.display = 'block';
                    const height = notice.clientHeight;
                    notice.style.top = `${offset.top - (height - (height / 3))}px`;
                  });
                  greenIcon.mouseout(function(event) {
                    notice.style.display = 'none';
                  });
                }

                if(item.icon === 'blue') {
                  self.iconsUsed.icon_blue.used = true;
                  svgCarNode.select(`#seat_${item.seat_position}`).attr({'visibility': 'visible'});
                  svgCarNode.select(`#seat_${item.seat_position} #icon_blue`).attr({'visibility': 'visible'});
                  const blueIcon = svgCarNode.select(`#seat_${item.seat_position} #icon_blue #hover_area`);
                  const notice = self.shadowRoot.querySelector(`#car_${carIndex}_seat_${item.seat_position}_notification`);
                  blueIcon.mousemove(function(event) {
                    const offset = self.offset(event.currentTarget);
                    notice.style.left = `${offset.left + 40}px`;
                    notice.style.display = 'block';
                    const height = notice.clientHeight;
                    notice.style.top = `${offset.top - (height - (height / 3))}px`;
                  });
                  blueIcon.mouseout(function(event) {
                    notice.style.display = 'none';
                  });
                }
                if(item.icon === 'red') {
                  self.iconsUsed.icon_red.used = true;
                  svgCarNode.select(`#seat_${item.seat_position}`).attr({'visibility': 'visible'});
                  svgCarNode.select(`#seat_${item.seat_position} #icon_red`).attr({'visibility': 'visible'});
                }
                if(item.icon === 'orange') {
                  self.iconsUsed.icon_orange.used = true;
                  svgCarNode.select(`#seat_${item.seat_position}`).attr({'visibility': 'visible'});
                  svgCarNode.select(`#seat_${item.seat_position} #icon_orange`).attr({'visibility': 'visible'});
                  const orangeIcon = svgCarNode.select(`#seat_${item.seat_position} #icon_orange #hover_area`);
                  const notice = self.shadowRoot.querySelector(`#car_${carIndex}_seat_${item.seat_position}_notification`);
                  orangeIcon.mousemove(function(event) {                
                    const offset = self.offset(event.currentTarget);
                    notice.style.display = 'block';
                    notice.style.top = '0px';
                    notice.style.left = '0px';
                    const width = notice.clientWidth;
                    const height = notice.clientHeight;
                    //if(self.breakpoints.mobileSmall || self.breakpoints.mobileMedium) {
                    //  setTimeout(function(){
                    //    const top = (offset.top - (height + 30));
                    //    console.log(offset.top, height, top);
                    //    notice.style.top = `${top}px`;
                    //    notice.style.left = `${(document.documentElement.clientWidth / 2) - (width / 2)}px`; 
                    //  }, 200);
                    //} else {
                      notice.style.top = `${offset.top - (height - (height / 3))}px`;
                      notice.style.left = `${offset.left + 40}px`;
                    //}
                  });
                  orangeIcon.mouseout(function(event) {
                    notice.style.display = 'none';
                  });
                }
                if(item.top_tether_position !== '' && data.product.top_tether) {
                  self.iconsUsed.icon_top_tether.used = true;
                  svgCarNode.select(`#seat_${item.seat_position} #icon_tether`).attr({'visibility': 'visible'});
                  const tetherIcon = svgCarNode.select(`#seat_${item.seat_position} #icon_tether #hover_area`);
                  const tether = self.shadowRoot.querySelector(`#car_${carIndex}_seat_${item.seat_position}_tether`);
                  tetherIcon.mousemove(function(event) {
                    const offset = self.offset(event.currentTarget);
                    tether.style.left = `${offset.left + 20}px`;
                    tether.style.display = 'block';
                    const height = tether.clientHeight;
                    tether.style.top = `${offset.top - (height - (height / 3))}px`;
                  });
                  tetherIcon.mouseout(function(event) {
                    tether.style.display = 'none';
                  });
                }
              });
              self.set('iconsUsed2', self.renderLegend());
              svgCarNode.attr({
                opacity: 100
              });
            }
              
            setTimeout(() => {
              const svgOldCarNode = this.shadowRoot.querySelector(`#car_${carIndex}`);
              if(svgOldCarNode) svgOldCarNode.remove();
              const container = this.shadowRoot.querySelector(`#svg_container_${carIndex}`);
              container.innerHTML = `<svg id="car_${carIndex}" class="svg_node"></svg>`;
              svgCarNode = Snap(this.shadowRoot.querySelector(`#car_${carIndex}`));
              if(data.car_body_configuration.includes('bench')) {
                self.set('carGraphics', 'car_graphics_bench');
              } else {
                self.set('carGraphics', 'car_graphics_normal');
              }
              const svgFile = this.get('carGraphics');
              Snap.load(`/assets/images/car-fitting/${svgFile}.svg`, onSVGLoaded);
            }, 0);
          }
        }
      }

      previousStep() {
        this.set('stepData.isCurrent', false);
        this.set('stepController.currentStep', this.stepData.previousStep);
      }
    }
    
    customElements.define(DorelCarFittingResults.is, DorelCarFittingResults);
  </script>  
</dom-module>
